{"name":"Authorization code flow","cells":[{"id":"0e067ab8-a4a2-4372-a3e1-ae46e4b8df0b","type":"markdown","value":"In this guide we are using Aidbox REST Mock feature which is useful e.g. debugging purposes.\n\nIt stores the last request to the given mock endpoint.\n\nHere we'll create mock endpoint with the URL: [/mock/auth-tutorial](/mock/auth-tutorial)","folded":{"code":true,"result":false},"result":"<p>In this guide we are using Aidbox REST Mock feature which is useful e.g. debugging purposes.</p><p>It stores the last request to the given mock endpoint.</p><p>Here we'll create mock endpoint with the URL: <a href='/mock/auth-tutorial'>/mock/auth-tutorial</a></p>"},{"id":"8b543665-4858-4c42-a113-180dccde1c8f","type":"rpc","value":"{\n  \"method\": \"aidbox.mock/mock-create\",\n  \"params\": {\n    \"id\": \"auth-tutorial\",\n    \"request-method\": \"get\",\n    \"response\": {\n      \"status\": 200,\n      \"body\": {\"message\": \"Hello\"}\n    }\n  }\n}","folded":{"result":false},"result":"{\"result\":{\"result\":\"ok\"}}"},{"id":"7eb9e50a-fcc3-4bd9-b214-9646cc830c22","type":"markdown","value":"Now we need to create a Client for which we will get token later","folded":{"code":true,"result":false},"result":"<p>Now we need to create a Client for which we will get token later</p>"},{"id":"391915c0-3d89-4de6-b3c2-0aa634b61601","type":"rest","value":"PUT /Client/web-app\ncontent-type: text/yaml\naccept: text/yaml\n\nsecret: verysecret\ngrant_types:\n  - code\nauth:\n  authorization_code:\n    redirect_uri: http://localhost:8765/mock/auth-tutorial","folded":{"result":false},"result":{"body":"auth:\n  authorization_code: {redirect_uri: 'http://localhost:8765/mock/auth-tutorial'}\nsecret: verysecret\ngrant_types: [code]\nid: web-app\nresourceType: Client\nmeta: {lastUpdated: '2021-08-17T11:04:24.662762Z', createdAt: '2021-08-17T11:00:14.117263Z', versionId: '805'}\n","status":200,"headers":{"etag":"805","x-duration":102,"content-type":"text/yaml","x-request-id":"9deec405-be8c-41d5-8628-9b05b7932b22","cache-control":"no-cache","last-modified":"Tue, 17 Aug 2021 11:04:24 GMT"}}},{"id":"973bfe14-fd58-4280-b720-d10339abe831","type":"markdown","value":"To authorize the client vizit [/auth/authorize?client\\_id=web-app&response_type=code](/auth/authorize?client_id=web-app&response_type=code)","folded":{"result":false},"result":"<p>To authorize the client vizit <a href='/auth/authorize?client_id=web-app&response_type=code'>/auth/authorize?client&#95;id=web-app&response_type=code</a></p>"},{"id":"dfa86a52-fcb7-4c24-9972-a07c4014cd02","type":"markdown","value":"Now we'll get the request data from the mock endpoint. The code is stored in `result.params.code`","folded":{"code":true,"result":false},"result":"<p>Now we'll get the request data from the mock endpoint. The code is stored in <code>result.params.code</code></p>"},{"id":"502b6a51-697e-4d63-b26e-2b70ca1587ba","type":"rpc","value":"{\n  \"method\": \"aidbox.mock/mock-get-request\",\n  \"params\": {\n    \"id\": \"auth-tutorial\"\n  }\n}","folded":{"result":false},"result":"{\"result\":{\"result\":{\"clojure-elastic-apm/transaction\":\"INSTANCE\",\"request-id\":\"2dabb9c5-b27d-4ad8-8889-8bb4b1b9ba4d\",\"cookies\":{\"_ym_uid\":{\"value\":\"1624012649802616529\"},\"_ym_d\":{\"value\":\"1624012649\"},\"_xsrf\":{\"value\":\"2|331950fd|93850da8dbb579d83a1459d262c0f8bc|1627981193\"},\"username-localhost-8888\":{\"value\":\"2|1:0|10:1628576185|23:username-localhost-8888|44:MDNkOGVjOTE5MjFmNGMxNzg1Mjk4MDEzMzE5OWU5ZjE=|ae31c7b51aa57fbb236b6852ce108e5b1aadc1864052409a54cba206b6d0c3bc\"},\"asid\":{\"value\":\"YjQ1NWMyMzAtMDZkOC00NTJlLWI5ZDUtODQ4NGJhMGNhZDRk\"},\"ssid\":{\"value\":\"NmMyMjJmYjAtMTI0ZC00YjdlLWI2MzUtZmMyNmE4ZDZmNDZl\"},\"intercom-id-fqdpw3fp\":{\"value\":\"51683071-9213-47f7-a819-115c908886c7\"},\"_ga\":{\"value\":\"GA1.1.797404071.1624012657\"},\"username-localhost-8889\":{\"value\":\"2|1:0|10:1627981846|23:username-localhost-8889|44:ZDJjOGY4M2Y0MjFmNGE1MmE5MDI0MzY5YjQzM2Y5Yjk=|d4ee9282d6e3f74ec67252d6310b4bd2b5466933b793dd4aa7640aa39d00503f\"}},\"remote-addr\":\"127.0.0.1\",\"params\":{\"code\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImNsaSI6IndlYi1hcHAiLCJleHAiOjE2MjkyMDE1NTMsImp0aSI6Ik1ESTFNRGRqTldVdE5XRXlaQzAwWm1Rd0xUa3dOR010WTJFMllXSTFaV1prWlRZMCJ9.k8_u7vrCpqVei4DGoVJ-l6Zns-4SjNZz3uFYvp6E3_A\"},\"route-params\":{\"mock/id\":\"auth-tutorial\"},\"headers\":{\"sec-fetch-site\":\"same-origin\",\"host\":\"localhost:8765\",\"user-agent\":\"Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0\",\"cookie\":\"intercom-id-fqdpw3fp=51683071-9213-47f7-a819-115c908886c7; _ym_uid=1624012649802616529; _ym_d=1624012649; _ga=GA1.1.797404071.1624012657; _xsrf=2|331950fd|93850da8dbb579d83a1459d262c0f8bc|1627981193; username-localhost-8889=\\\"2|1:0|10:1627981846|23:username-localhost-8889|44:ZDJjOGY4M2Y0MjFmNGE1MmE5MDI0MzY5YjQzM2Y5Yjk=|d4ee9282d6e3f74ec67252d6310b4bd2b5466933b793dd4aa7640aa39d00503f\\\"; username-localhost-8888=\\\"2|1:0|10:1628576185|23:username-localhost-8888|44:MDNkOGVjOTE5MjFmNGMxNzg1Mjk4MDEzMzE5OWU5ZjE=|ae31c7b51aa57fbb236b6852ce108e5b1aadc1864052409a54cba206b6d0c3bc\\\"; ssid=NmMyMjJmYjAtMTI0ZC00YjdlLWI2MzUtZmMyNmE4ZDZmNDZl; asid=YjQ1NWMyMzAtMDZkOC00NTJlLWI5ZDUtODQ4NGJhMGNhZDRk\",\"sec-fetch-user\":\"?1\",\"referer\":\"http://localhost:8765/auth/grant?client_id=web-app&response_type=code\",\"connection\":\"keep-alive\",\"upgrade-insecure-requests\":\"1\",\"accept\":\"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\",\"accept-language\":\"en-US,en;q=0.5\",\"sec-fetch-dest\":\"document\",\"accept-encoding\":\"gzip, deflate\",\"sec-fetch-mode\":\"navigate\",\"x-request-id\":\"2dabb9c5-b27d-4ad8-8889-8bb4b1b9ba4d\"},\"async-channel\":\"/127.0.0.1:8765<->/127.0.0.1:38232\",\"server-port\":8765,\"oauth/user\":{\"id\":\"admin\",\"password\":\"$s0$f0801$45hRadZsbuLFUW8EbROhvg==$Gu0PfY3EUHfV+opgsma1wgstu7kwEuCbWkMRKjqOcGs=\",\"resourceType\":\"User\"},\"content-length\":0,\"websocket?\":false,\"content-type\":null,\"character-encoding\":\"utf8\",\"oauth/session\":{\"id\":\"adb27031-fbde-41b5-baf8-f9257e164c4b\",\"meta\":{\"versionId\":707,\"lastUpdated\":\"2021-08-13T16:07:43.531679+03:00\"},\"type\":\"login\",\"access_token\":\"YjQ1NWMyMzAtMDZkOC00NTJlLWI5ZDUtODQ4NGJhMGNhZDRk\"},\"uri\":\"/mock/auth-tutorial\",\"server-name\":\"localhost\",\"query-string\":\"code=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImNsaSI6IndlYi1hcHAiLCJleHAiOjE2MjkyMDE1NTMsImp0aSI6Ik1ESTFNRGRqTldVdE5XRXlaQzAwWm1Rd0xUa3dOR010WTJFMllXSTFaV1prWlRZMCJ9.k8_u7vrCpqVei4DGoVJ-l6Zns-4SjNZz3uFYvp6E3_A\",\"body\":null,\"scheme\":\"http\",\"request-method\":\"get\"}}}"},{"id":"41c4289a-e1be-4850-9420-c74ef5900ed9","type":"markdown","value":"To exchange code to authorization token, use the following query:","folded":{"code":true,"result":false},"result":"<p>To exchange code to authorization token, use the following query:</p>"},{"id":"d4183094-523a-4513-b690-d53cc52d87d9","type":"rest","value":"POST /auth/token\nContent-Type: application/json\n\n{\n \"client_id\": \"web-app\",\n \"code\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImNsaSI6IndlYi1hcHAiLCJleHAiOjE2MjkyMDE1NTMsImp0aSI6Ik1ESTFNRGRqTldVdE5XRXlaQzAwWm1Rd0xUa3dOR010WTJFMllXSTFaV1prWlRZMCJ9.k8_u7vrCpqVei4DGoVJ-l6Zns-4SjNZz3uFYvp6E3_A\",\n \"grant_type\": \"authorization_code\"\n}","folded":{"result":false},"result":{"body":"{\"token_type\":\"Bearer\",\"userinfo\":{\"id\":\"admin\",\"resourceType\":\"User\",\"meta\":{\"lastUpdated\":\"2021-08-17T11:45:52.535235Z\",\"createdAt\":\"2021-08-16T07:50:36.076494Z\",\"versionId\":\"824\"},\"sub\":\"admin\"},\"access_token\":\"MmRhYzdhNTktNDhkOS00ZWYzLThkZDQtYzFkYTBkMDZmMzM1\"}","status":200,"headers":{"pragma":"no-cache","Set-Cookie":["asid=MmRhYzdhNTktNDhkOS00ZWYzLThkZDQtYzFkYTBkMDZmMzM1;Path=/"],"x-duration":31,"content-type":"application/json","x-request-id":"73c8625b-e44b-4d4a-9554-c96ab3d1874c","cache-control":"no-cache, no-store, max-age=0, must-revalidate"}}},{"id":"c4ef4b20-825e-47a4-9c9b-d668c9d85b7b","type":"markdown","value":"Now we can use the token to make requests with the client","folded":{"code":true,"result":false},"result":"<p>Now we can use the token to make requests with the client</p>"},{"id":"c6affa16-7cac-450e-9d38-e179c07c6107","type":"rest","value":"GET /Patient\nauthorization: Bearer MmRhYzdhNTktNDhkOS00ZWYzLThkZDQtYzFkYTBkMDZmMzM1","folded":{"result":false},"result":{"body":"{\"query-time\":7,\"meta\":{\"versionId\":\"833\"},\"type\":\"searchset\",\"resourceType\":\"Bundle\",\"total\":9,\"link\":[{\"relation\":\"first\",\"url\":\"/Patient?page=1\"},{\"relation\":\"self\",\"url\":\"/Patient?page=1\"}],\"query-timeout\":60000,\"entry\":[{\"resource\":{\"name\":[{\"family\":\"John\"}],\"id\":\"pt-2\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-03T11:16:43.948207Z\",\"createdAt\":\"2021-08-03T11:16:43.948207Z\",\"versionId\":\"322\"}},\"fullUrl\":\"http://localhost:8765/Patient/pt-2\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/pt-2\"}]},{\"resource\":{\"name\":[{\"given\":[\"Jane2\"]}],\"id\":\"pt-1\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-02T10:22:33.373604Z\",\"createdAt\":\"2021-08-02T10:22:33.373604Z\",\"versionId\":\"241\"}},\"fullUrl\":\"http://localhost:8765/Patient/pt-1\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/pt-1\"}]},{\"resource\":{\"id\":\"45fa51db-1846-44a5-b087-7c70dab0b9ec\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-05T13:58:24.210981Z\",\"createdAt\":\"2021-08-05T13:58:24.210981Z\",\"versionId\":\"400\"}},\"fullUrl\":\"http://localhost:8765/Patient/45fa51db-1846-44a5-b087-7c70dab0b9ec\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/45fa51db-1846-44a5-b087-7c70dab0b9ec\"}]},{\"resource\":{\"id\":\"351a7851-3d27-4235-85c9-e394c1eb65b5\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-05T14:01:12.302393Z\",\"createdAt\":\"2021-08-05T14:01:12.302393Z\",\"versionId\":\"407\"}},\"fullUrl\":\"http://localhost:8765/Patient/351a7851-3d27-4235-85c9-e394c1eb65b5\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/351a7851-3d27-4235-85c9-e394c1eb65b5\"}]},{\"resource\":{\"id\":\"a513fa8c-a99e-4384-8009-0be646208b82\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-05T14:12:33.543328Z\",\"createdAt\":\"2021-08-05T14:12:33.543328Z\",\"versionId\":\"425\"}},\"fullUrl\":\"http://localhost:8765/Patient/a513fa8c-a99e-4384-8009-0be646208b82\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/a513fa8c-a99e-4384-8009-0be646208b82\"}]},{\"resource\":{\"id\":\"609adea4-fa19-49ee-be09-76728c395ef9\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-05T14:36:29.704095Z\",\"createdAt\":\"2021-08-05T14:36:29.704095Z\",\"versionId\":\"446\"}},\"fullUrl\":\"http://localhost:8765/Patient/609adea4-fa19-49ee-be09-76728c395ef9\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/609adea4-fa19-49ee-be09-76728c395ef9\"}]},{\"resource\":{\"id\":\"53eaa7e6-a92c-4e19-96a2-ebaab1c0fc5e\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-05T14:36:33.925324Z\",\"createdAt\":\"2021-08-05T14:36:33.925324Z\",\"versionId\":\"448\"}},\"fullUrl\":\"http://localhost:8765/Patient/53eaa7e6-a92c-4e19-96a2-ebaab1c0fc5e\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/53eaa7e6-a92c-4e19-96a2-ebaab1c0fc5e\"}]},{\"resource\":{\"id\":\"9d134068-162c-453c-9f40-fe5cfa495c35\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-05T14:37:30.648297Z\",\"createdAt\":\"2021-08-05T14:37:30.648297Z\",\"versionId\":\"452\"}},\"fullUrl\":\"http://localhost:8765/Patient/9d134068-162c-453c-9f40-fe5cfa495c35\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/9d134068-162c-453c-9f40-fe5cfa495c35\"}]},{\"resource\":{\"id\":\"pt-3\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-12T07:45:08.409591Z\",\"createdAt\":\"2021-08-12T07:45:08.409591Z\",\"versionId\":\"541\"}},\"fullUrl\":\"http://localhost:8765/Patient/pt-3\",\"link\":[{\"relation\":\"self\",\"url\":\"http://localhost:8765/Patient/pt-3\"}]}],\"query-sql\":[\"SELECT \\\"patient\\\".* FROM \\\"patient\\\" LIMIT ? OFFSET ? \",100,0]}","status":200,"headers":{"etag":"833","x-duration":24,"content-type":"application/json","x-request-id":"a2636b0a-f8a7-4e48-90ed-e6e96f36d3af"}}},{"id":"09199e37-158b-4fb9-9e3a-106f63cc625d","type":"markdown","value":"To delete a token, make a `DELETE` request to the `/Session` endpoint","folded":{"code":true,"result":false},"result":"<p>To delete a token, make a <code>DELETE</code> request to the <code>/Session</code> endpoint</p>"},{"id":"9108affd-2e66-482a-9668-3001f0bce4f4","type":"rest","value":"DELETE /Session\nauthorization: Bearer MmRhYzdhNTktNDhkOS00ZWYzLThkZDQtYzFkYTBkMDZmMzM1","folded":{"result":false},"result":{"body":"{\"message\":\"Session [c6b0b751-99e6-46a9-b48c-d4fb45d62ded] was closed\"}","status":200,"headers":{"Set-Cookie":["asid=;Path=/;Expires=Thu, 01 Jan 1970 00:00:00 GMT"],"x-duration":29,"content-type":"application/json","x-request-id":"5928420d-ced1-4669-ae86-1336a2030a31"}}},{"id":"681b6dc4-87d5-4731-a54a-954af6821fa0","type":"markdown","value":"After the session closed, all requests requiring authentication with this token are rejected","folded":{"code":true,"result":false},"result":"<p>After the session closed, all requests requiring authentication with this token are rejected</p>"},{"id":"1d353f2d-1432-4398-947c-6d92740b1158","type":"rest","value":"GET /Patient\nauthorization: Bearer MmRhYzdhNTktNDhkOS00ZWYzLThkZDQtYzFkYTBkMDZmMzM1","folded":{"result":false},"result":{"body":"{\"message\":\"No session for passed bearer token or no TokenIntrospectors with type='opaque' was able to validate it\"}","status":401,"headers":{"pragma":"no-cache","x-duration":3,"content-type":"application/json","x-request-id":"7c9826b1-a6e3-423e-be0d-e012883d4c35","cache-control":"no-cache, no-store, max-age=0, must-revalidate"}}}],"description":"Learn how to use authorization code","id":"b90b669b-c10e-4add-95ac-995ec73ee84f","resourceType":"Notebook","meta":{"lastUpdated":"2021-08-17T12:12:12.490593Z","createdAt":"2021-08-17T11:00:24.204374Z","versionId":"837"},"tags":["auth"]}
