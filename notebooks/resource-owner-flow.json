{"name":"Resource owner flow","cells":[{"id":"2bcd5e82-33dc-4342-9245-f6899928b2bf","type":"markdown","value":"In this guide we will create Client and User. \nThen we'll get token for the Client which will have the same rights as the User who requested the token.","folded":{"code":true,"result":false},"result":"<p>In this guide we will create Client and User.  Then we'll get token for the Client which will have the same rights as the User who requested the token.</p>"},{"id":"ddbb308a-6c8c-46bf-a61a-312dfff47523","type":"markdown","value":"### Create client `password-client`:","folded":{"code":true,"result":false},"result":"<h3>Create client <code>password-client</code>:</h3>"},{"id":"21c4b97b-e140-4791-89b0-7eeec44765df","type":"rest","value":"PUT /Client/password-client\ncontent-type: text/yaml\naccept: text/yaml\n\nsecret: verysecret\ngrant_types:\n  - password\n# Uncomment to use additional features:\n# auth:\n#   password:\n#     token_format: jwt\n#     secret_required: true\n#     refresh_token: true","folded":{"result":false},"result":{"body":"secret: verysecret\ngrant_types: [password]\nid: password-client\nresourceType: Client\nmeta: {lastUpdated: '2021-08-12T14:08:17.005871Z', createdAt: '2021-08-12T14:08:17.005871Z', versionId: '579'}\n","status":201,"headers":{"etag":"579","location":"/Client/password-client/_history/579","x-duration":6,"content-type":"text/yaml","x-request-id":"ce3fe794-9102-40e5-9d10-b485f2c464c5","cache-control":"no-cache","last-modified":"Thu, 12 Aug 2021 14:08:17 GMT"}}},{"id":"db694a01-f6d6-4fc1-963b-4d68efb7731d","type":"markdown","value":"### Create user `user-1` who will request token for the client:","folded":{"code":true,"result":false},"result":"<h3>Create user <code>user-1</code> who will request token for the client:</h3>"},{"id":"597ed55d-a5d2-4acd-87ef-2369f731c1fd","type":"rest","value":"PUT /User/user-1\ncontent-type: text/yaml\naccept: text/yaml\n\nemail: user@mail.com\npassword: password","folded":{"result":false},"result":{"body":"email: user@mail.com\npassword: $s0$f0801$WL2u+MYVu9LXgC9sQSgWjw==$uPJ4k8OVAIsVD9AuIi3QUUYWg7jyl7zjN+sxrUXZILE=\nid: user-1\nresourceType: User\nmeta: {lastUpdated: '2021-08-12T14:08:21.289132Z', createdAt: '2021-08-12T14:08:21.289132Z', versionId: '580'}\n","status":201,"headers":{"etag":"580","location":"/User/user-1/_history/580","x-duration":71,"content-type":"text/yaml","x-request-id":"11c2ccfb-9e50-45c8-ba3a-a3861a97d3b7","cache-control":"no-cache","last-modified":"Thu, 12 Aug 2021 14:08:21 GMT"}}},{"id":"a257a735-d2bc-4fe7-9b85-07009e493f52","type":"markdown","value":"### Create access policy which allows the user to interact with patient resources:","folded":{"code":true,"result":false},"result":"<h3>Create access policy which allows the user to interact with patient resources:</h3>"},{"id":"2955a992-7ca1-4c23-b7ed-a45544bd9404","type":"rest","value":"PUT /AccessPolicy/resource-owner-flow\ncontent-type: text/yaml\naccept: text/yaml\n\nid: resource-owner-flow\nresourceType: AccessPolicy\nengine: matcho\nmatcho:\n  uri: '#/Patient.*'\nlink:\n  - id: user-1\n    resourceType: User","folded":{"result":false},"result":{"body":"link:\n- {id: user-1, resourceType: User}\nengine: matcho\nmatcho: {uri: '#/Patient.*'}\nid: resource-owner-flow\nresourceType: AccessPolicy\nmeta: {lastUpdated: '2021-08-12T14:08:59.995045Z', createdAt: '2021-08-12T14:08:59.995045Z', versionId: '584'}\n","status":201,"headers":{"etag":"584","location":"/AccessPolicy/resource-owner-flow/_history/584","x-duration":10,"content-type":"text/yaml","x-request-id":"a1b1e027-5d5e-45c2-9455-a655d3a0a209","cache-control":"no-cache","last-modified":"Thu, 12 Aug 2021 14:08:59 GMT"}}},{"id":"081584d8-7751-4b02-9747-8c1d0bb96602","type":"markdown","value":"### Get token for the client on behalf of the user:","folded":{"code":true,"result":false},"result":"<h3>Get token for the client on behalf of the user:</h3>"},{"id":"2dffec21-9467-42fd-ae45-73784e361286","type":"rest","value":"POST /auth/token\nContent-Type: text/yaml\naccept: text/yaml\n\nclient_id: password-client\ngrant_type: password\nusername: user@mail.com\npassword: password","folded":{"result":false},"result":{"body":"token_type: Bearer\nuserinfo:\n  email: user@mail.com\n  id: user-1\n  resourceType: User\n  meta: {lastUpdated: '2021-08-12T14:08:21.289132Z', createdAt: '2021-08-12T14:08:21.289132Z', versionId: '580'}\naccess_token: NWM2OTc0OTMtNDI4Zi00NDE0LTkwODctNTFhNTdlZGYzMjA4\n","status":200,"headers":{"pragma":"no-cache","Set-Cookie":["asid=NWM2OTc0OTMtNDI4Zi00NDE0LTkwODctNTFhNTdlZGYzMjA4;Path=/"],"x-duration":89,"content-type":"text/yaml","x-request-id":"271b6ec9-865d-46a2-b0d4-30b780bd3db4","cache-control":"no-cache, no-store, max-age=0, must-revalidate"}}},{"id":"7859da45-149d-412f-ab63-bf8756f322a7","type":"markdown","value":"We can see the generated token in the response. In our case it is\n```\nNWM2OTc0OTMtNDI4Zi00NDE0LTkwODctNTFhNTdlZGYzMjA4\n```\nBut it is randomly generated therefore when you will run the cell it will differ","folded":{"code":true,"result":false},"result":"<p>We can see the generated token in the response. In our case it is</p><pre><code>NWM2OTc0OTMtNDI4Zi00NDE0LTkwODctNTFhNTdlZGYzMjA4\n</code></pre><p>But it is randomly generated therefore when you will run the cell it will differ</p>"},{"id":"5cb2d7f1-d0cd-452f-ac54-a6272c97196d","type":"markdown","value":"### Get the patient with the newly generated token:","folded":{"code":true,"result":false},"result":"<h3>Get the patient with the newly generated token:</h3>"},{"id":"13bc1682-341c-4728-913e-422afae0876f","type":"rest","value":"GET /Patient/pt-1\nAuthorization: Bearer NWM2OTc0OTMtNDI4Zi00NDE0LTkwODctNTFhNTdlZGYzMjA4","folded":{"result":false},"result":{"body":"{\"name\":[{\"given\":[\"Jane2\"]}],\"id\":\"pt-1\",\"resourceType\":\"Patient\",\"meta\":{\"lastUpdated\":\"2021-08-02T10:22:33.373604Z\",\"createdAt\":\"2021-08-02T10:22:33.373604Z\",\"versionId\":\"241\"}}","status":200,"headers":{"etag":"241","x-duration":5,"content-type":"application/json","x-request-id":"fdf12c83-00a0-4779-9593-0a59de7fc127","cache-control":"no-cache","last-modified":"Mon, 02 Aug 2021 10:22:33 GMT"}}},{"id":"4dbd8005-b991-414e-8854-b67ba22c90b5","type":"markdown","value":"### Close the session for the token:","folded":{"code":true,"result":false},"result":"<h3>Close the session for the token:</h3>"},{"id":"d548b5cf-ec0c-46f2-abfa-088e5b3b6be4","type":"rest","value":"DELETE /Session\nAuthorization: Bearer NWM2OTc0OTMtNDI4Zi00NDE0LTkwODctNTFhNTdlZGYzMjA4","folded":{"result":false},"result":{"body":"{\"message\":\"Session [8b4ccb19-4a86-48ef-afff-1dd8d22aed2d] was closed\"}","status":200,"headers":{"Set-Cookie":["asid=;Path=/;Expires=Thu, 01 Jan 1970 00:00:00 GMT"],"x-duration":8,"content-type":"application/json","x-request-id":"4a721f19-836d-405e-9170-3b78dba2fba6"}}},{"id":"5f1e674a-5e30-4b54-a90f-1a3ae63823f0","type":"markdown","value":"The session is now closed. If we will try to use the token again, we will receive authorization error:","folded":{"code":true,"result":false},"result":"<p>The session is now closed. If we will try to use the token again, we will receive authorization error:</p>"},{"id":"a1bb4257-3681-4c8a-b5a8-97ea4fe9ae70","type":"rest","value":"GET /Patient/pt-1\nAuthorization: Bearer NWM2OTc0OTMtNDI4Zi00NDE0LTkwODctNTFhNTdlZGYzMjA4","folded":{"result":false},"result":{"body":"{\"message\":\"No session for passed bearer token or no TokenIntrospectors with type='opaque' was able to validate it\"}","status":401,"headers":{"pragma":"no-cache","x-duration":3,"content-type":"application/json","x-request-id":"e9ed2ec1-70ac-4d83-ae3e-7d4f58c6b91e","cache-control":"no-cache, no-store, max-age=0, must-revalidate"}}}],"description":"Allows to use User permissions for client-based queries","id":"8385717d-3331-4e32-917c-9601cb5e5551","resourceType":"Notebook","meta":{"lastUpdated":"2021-08-12T14:23:01.478427Z","createdAt":"2021-08-12T13:58:04.106321Z","versionId":"589"},"tags":["auth"]}
