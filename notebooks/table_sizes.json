{"name":"Table Sizes","tags":["db"],"cells":[{"id":"2e08bbef-dd6b-48f5-8e23-e27fdab2843c","type":"sql","value":"\nWITH RECURSIVE pg_inherit(inhrelid, inhparent) AS\n    (select inhrelid, inhparent\n    FROM pg_inherits\n    UNION\n    SELECT child.inhrelid, parent.inhparent\n    FROM pg_inherit child, pg_inherits parent\n    WHERE child.inhparent = parent.inhrelid),\npg_inherit_short AS (SELECT * FROM pg_inherit WHERE inhparent NOT IN (SELECT inhrelid FROM pg_inherit))\nSELECT table_schema\n    , TABLE_NAME\n    , row_estimate\n    , pg_size_pretty(total_bytes) AS total\n    , pg_size_pretty(index_bytes) AS INDEX\n    , pg_size_pretty(toast_bytes) AS toast\n    , pg_size_pretty(table_bytes) AS TABLE\n  FROM (\n    SELECT *, total_bytes-index_bytes-COALESCE(toast_bytes,0) AS table_bytes\n    FROM (\n         SELECT c.oid\n              , nspname AS table_schema\n              , relname AS TABLE_NAME\n              , SUM(c.reltuples) OVER (partition BY parent) AS row_estimate\n              , SUM(pg_total_relation_size(c.oid)) OVER (partition BY parent) AS total_bytes\n              , SUM(pg_indexes_size(c.oid)) OVER (partition BY parent) AS index_bytes\n              , SUM(pg_total_relation_size(reltoastrelid)) OVER (partition BY parent) AS toast_bytes\n              , parent\n          FROM (\n                SELECT pg_class.oid\n                    , reltuples\n                    , relname\n                    , relnamespace\n                    , pg_class.reltoastrelid\n                    , COALESCE(inhparent, pg_class.oid) parent\n                FROM pg_class\n                    LEFT JOIN pg_inherit_short ON inhrelid = oid\n                WHERE relkind IN ('r', 'p')\n             ) c\n             LEFT JOIN pg_namespace n ON n.oid = c.relnamespace\n  ) a\n  WHERE oid = parent\n) a\nORDER BY total_bytes DESC;"}],"id":"dbf35782-6c54-4af8-afcd-afe1d2651a8f","resourceType":"Notebook","meta":{"lastUpdated":"2021-08-12T12:44:05.961576Z","createdAt":"2021-08-12T12:40:33.821591Z","versionId":"590"}}
